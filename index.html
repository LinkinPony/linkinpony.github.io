<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"linkinpony.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="website">
<meta property="og:title" content="I always love dashie">
<meta property="og:url" content="http://linkinpony.github.io/index.html">
<meta property="og:site_name" content="I always love dashie">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="LinkinPony">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://linkinpony.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>I always love dashie</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">I always love dashie</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LinkinPony</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/LinkinPony" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;LinkinPony" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://codeforces.com/profile/LinkinPony" title="CodeForces → https:&#x2F;&#x2F;codeforces.com&#x2F;profile&#x2F;LinkinPony" rel="noopener" target="_blank"><i class="code fa-fw"></i>CodeForces</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://acker.fun/" title="https:&#x2F;&#x2F;acker.fun&#x2F;" rel="noopener" target="_blank">Acker</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://kmguan-528.github.io/" title="https:&#x2F;&#x2F;kmguan-528.github.io&#x2F;" rel="noopener" target="_blank">KMGuan</a>
        </li>
    </ul>
  </div>

          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://linkinpony.github.io/2022/05/29/GAMES104-homework-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LinkinPony">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I always love dashie">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/29/GAMES104-homework-2/" class="post-title-link" itemprop="url">[GAMES104]-作业2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-05-29 07:50:50 / Modified: 17:05:30" itemprop="dateCreated datePublished" datetime="2022-05-29T07:50:50+08:00">2022-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GAMES104/" itemprop="url" rel="index"><span itemprop="name">GAMES104</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>因为一直要赶一堆莫名其妙的ddl和考试 task3没做 日后再补_(:з」∠)_</p>
<h2 id="color-grading与lut">Color Grading与LUT</h2>
<p>调色是增强画面表现力的一种很有效的手段. 本次作业我们处理的颜色在sRGB空间内, 红、绿、蓝三个颜色分别用一个<span class="math inline">\([0,1]\)</span>的实数来表示. 将三原色分别用一个坐标轴来表示, 便构成了如图所示的色彩空间(图片来自<a target="_blank" rel="noopener" href="https://defold.com/tutorials/grading/">defold.com</a>):</p>
<p><img src="https://defold.com/tutorials/images/grading/color_cube.png" alt="color cube" style="zoom:33%;" /></p>
<p>在进行调色时, 我们对渲染结果的每个像素进行处理, 根据像素原本的RGB值将其映射到一个新的色彩空间. 这种映射一般采用LUT(look up table)图来进行. LUT有1D和3D之分, Pilot Engine使用的是3D的LUT, 它看上去像这个样子:</p>
<p><img src="E:\Github\Pilot_Homework2\engine\asset\texture\lut\color_grading_LUT.jpg" /></p>
<p>这张图片的长为<span class="math inline">\(1024\)</span>个像素, 宽为<span class="math inline">\(32\)</span>个像素, 可以看出它由<span class="math inline">\(32\)</span>个小色块组成. 将这些小方块自上而下拼接在一起, 便组成了一个<span class="math inline">\(32 \times 32 \times 32\)</span>的色彩空间. 我们需要做的便是根据每个像素的RGB分量找到它在这张图上对应的像素. 具体来说, 原像素的<span class="math inline">\(G\)</span>分量指示了新像素在LUT上的纵坐标, <span class="math inline">\(B\)</span>分量指示了新像素所属的色块编号, <span class="math inline">\(R\)</span>分量指示了新像素在某个色块内部的横坐标.</p>
<h2 id="编写shader">编写Shader</h2>
<p>我们需要编写的Shader文件是<code>color_grading.frag</code>, 可以在<code>\engine\shader\glsl\</code>中找到.</p>
<p>这个shader已经提供了原像素的颜色<code>in_color</code>和LUT的2D采样器<code>color_grading_lut_texture_sampler</code>. 我们需要根据原像素的颜色计算出调色后的颜色并将其赋值给<code>out_color</code>作为输出.</p>
<p>在计算前, 需要获取像素的颜色值:</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">highp</span> <span class="type">vec4</span> color = subpassLoad(in_color).rgba;</span><br></pre></td></tr></table></figure>
<p>颜色值是一个四维向量, 四个维度分别代表R、G、B和alpha, 均为<span class="math inline">\([0,1]\)</span>的实数.</p>
<p>在计算出坐标后, 需要从LUT上获取对应的颜色:</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">highp</span> <span class="type">vec4</span> color_sampled = <span class="built_in">texture</span>(color_grading_lut_texture_sampler, uv);</span><br></pre></td></tr></table></figure>
<p>其中<code>color_grading_lut_texture_sampler</code>已经提供, <code>uv</code>是一个二维向量, <span class="math inline">\(u\)</span>代表横坐标, <span class="math inline">\(v\)</span>代表纵坐标, 坐标原点在图片的左上角, <span class="math inline">\(x\)</span>轴方向向右, <span class="math inline">\(y\)</span>轴方向向下. <span class="math inline">\(u,v\)</span>也是<span class="math inline">\([0,1]\)</span>上的实数.</p>
<p>我们还需要获取LUT的长宽:</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">highp</span> <span class="type">ivec2</span> lut_tex_size = <span class="built_in">textureSize</span>(color_grading_lut_texture_sampler, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>有了如上函数, 不难计算出每个像素在LUT上的对应位置. 设<span class="math inline">\(C\)</span>是LUT的宽, <span class="math inline">\(R,G,B\)</span>分别为像素的原颜色分量, 则有: <span class="math display">\[
u = \frac{\lfloor B \cdot C \rfloor + R}{C}\\
v = G
\]</span> 为了提高准确度和防止越界, 可以在LUT的边界上各留出0.5个像素, 将RGB值映射到<span class="math inline">\(C-1\)</span>个像素中去. 具体细节见代码:</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 310 es</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#extension GL_GOOGLE_include_directive : enable</span></span><br><span class="line"><span class="comment">//#extension GL_KHR_vulkan_glsl : enable</span></span><br><span class="line"><span class="meta">#include &quot;constants.h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span>(input_attachment_index = <span class="number">0</span>, set = <span class="number">0</span>, <span class="keyword">binding</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="keyword">highp</span> subpassInput in_color;</span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span>(set = <span class="number">0</span>, <span class="keyword">binding</span> = <span class="number">1</span>) <span class="keyword">uniform</span> <span class="type">sampler2D</span> color_grading_lut_texture_sampler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">out</span> <span class="keyword">highp</span> <span class="type">vec4</span> out_color;</span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">highp</span> <span class="type">ivec2</span> lut_tex_size = <span class="built_in">textureSize</span>(color_grading_lut_texture_sampler, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">highp</span> <span class="type">float</span> COLORS       = <span class="type">float</span>(lut_tex_size.y);<span class="comment">//LUT的每一维的颜色数量</span></span><br><span class="line">    <span class="keyword">highp</span> <span class="type">vec4</span>  color        = subpassLoad(in_color).rgba;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">highp</span> <span class="type">float</span> max_color = COLORS - <span class="number">1.0</span>;<span class="comment">//允许使用的最大元素</span></span><br><span class="line">    <span class="keyword">highp</span> <span class="type">float</span> half_pix_u = <span class="number">0.5</span> / <span class="type">float</span>(lut_tex_size.x);<span class="comment">//预留出半个像素</span></span><br><span class="line">    <span class="keyword">highp</span> <span class="type">float</span> half_pix_v = <span class="number">0.5</span> / <span class="type">float</span>(lut_tex_size.y);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">highp</span> <span class="type">float</span> part = <span class="built_in">floor</span>(color.b * max_color);<span class="comment">//根据B计算出该像素所属的色块编号</span></span><br><span class="line">    <span class="keyword">highp</span> <span class="type">float</span> threshold = max_color / COLORS;<span class="comment">//现在只有COLORS-1个颜色可用</span></span><br><span class="line">    <span class="keyword">highp</span> <span class="type">float</span> u = (half_pix_u + threshold * color.r + part) / COLORS;</span><br><span class="line">    <span class="keyword">highp</span> <span class="type">float</span> v = (half_pix_v + threshold * color.g);</span><br><span class="line">    <span class="comment">//预留出0.5像素的边界.例如假设COLORS = 32,在G = 0时v = 0.5/32,G = 1时v = 31.5/32</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">highp</span> <span class="type">vec2</span> uv = <span class="type">vec2</span>(u,v);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">highp</span> <span class="type">vec4</span> color_sampled = <span class="built_in">texture</span>(color_grading_lut_texture_sampler, uv);</span><br><span class="line"></span><br><span class="line">    out_color =  color_sampled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="效果展示与自定义lut">效果展示与自定义LUT</h2>
<p>在<code>\engine\asset\texture\lut</code>中存放着不同的LUT. 通过修改<code>\engine\asset\global\rendering.global.json</code>中<code>"color_grading_map"</code>项可以替换不同的LUT.</p>
<p>在不进行调色时的效果是这样的:</p>
<figure>
<img src="E:\Github\hexo\source_posts\GAMES104-homework-2.assets\image-20220529161702147.png" alt="image-20220529161702147" /><figcaption aria-hidden="true">image-20220529161702147</figcaption>
</figure>
<p>调色后的效果:</p>
<figure>
<img src="E:\Github\hexo\source_posts\GAMES104-homework-2.assets\image-20220529162809564.png" alt="image-20220529162809564" /><figcaption aria-hidden="true">image-20220529162809564</figcaption>
</figure>
<p>要创建自定义的LUT, 只需在GIMP或者PhotoShop等工具编辑原始LUT图像(可以附一张截图方便观察调色效果).</p>
<p>负片效果的LUT:</p>
<p><img src="E:\Github\Pilot_Homework2\engine\asset\texture\lut\LUT32_Invert.png" /></p>
<figure>
<img src="E:\Github\hexo\source_posts\GAMES104-homework-2.assets\image-20220529165605604.png" alt="image-20220529165605604" /><figcaption aria-hidden="true">image-20220529165605604</figcaption>
</figure>
<p>偏冷色调(好像太绿了):</p>
<p><img src="E:\Github\Pilot_Homework2\engine\asset\texture\lut\LUT32_qwq.png" /></p>
<figure>
<img src="E:\Github\hexo\source_posts\GAMES104-homework-2.assets\image-20220529165831153.png" alt="image-20220529165831153" /><figcaption aria-hidden="true">image-20220529165831153</figcaption>
</figure>
<p>PS:调色后会出现看上去很奇怪的色块, 目前还不知道如何解决</p>
<p><img src="E:\Github\hexo\source\_posts\GAMES104-homework-2.assets\image-20220529165922432.png" alt="image-20220529165922432" style="zoom:33%;" /></p>
<p><img src="E:\Github\hexo\source\_posts\GAMES104-homework-2.assets\image-20220529165936292.png" alt="image-20220529165936292" style="zoom:33%;" /></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://linkinpony.github.io/2022/04/30/demo-render/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LinkinPony">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I always love dashie">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/30/demo-render/" class="post-title-link" itemprop="url">[笔记]从0开始搓一个简单的render</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-30 11:39:36" itemprop="dateCreated datePublished" datetime="2022-04-30T11:39:36+08:00">2022-04-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-06-22 09:06:49" itemprop="dateModified" datetime="2022-06-22T09:06:49+08:00">2022-06-22</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%9B%BE%E5%BD%A2%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">图形学</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文的主要内容是对Dmitry V. Sokolov的<a target="_blank" rel="noopener" href="https://github.com/ssloy/tinyrenderer">tinyrender</a>课程的记录和补充.</p>
<h1 id="step-0环境搭建">Step 0：环境搭建</h1>
<p>我们需要<code>tgaimage.h</code>来操作TGA文件, <code>model.h</code>来操作模型. 头文件和实现可以在这里找到:</p>
<p>https://github.com/ssloy/tinyrenderer/tree/f6fecb7ad493264ecd15e230411bfb1cca539a12</p>
<p>可以用如下代码来测试:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;tgaimage.h&quot;</span></span></span><br><span class="line"><span class="keyword">const</span> TGAColor white = <span class="built_in">TGAColor</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>);</span><br><span class="line"><span class="keyword">const</span> TGAColor red   = <span class="built_in">TGAColor</span>(<span class="number">255</span>, <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">255</span>);</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">        <span class="function">TGAImage <span class="title">image</span><span class="params">(<span class="number">100</span>, <span class="number">100</span>, TGAImage::RGB)</span></span>;</span><br><span class="line">        image.<span class="built_in">set</span>(<span class="number">52</span>, <span class="number">41</span>, red);</span><br><span class="line">        image.<span class="built_in">flip_vertically</span>(); <span class="comment">// i want to have the origin at the left bottom corner of the image</span></span><br><span class="line">        image.<span class="built_in">write_tga_file</span>(<span class="string">&quot;output.tga&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到一个有红点的TGA文件:</p>
<p><img src="E:\Github\hexo\source\_posts\demo-render.assets\image-20220430115033896.png" alt="image-20220430115033896" style="zoom:25%;" /></p>
<h1 id="step-1画一条直线">Step 1：画一条直线</h1>
<h2 id="朴素算法">朴素算法</h2>
<p>我们需要在二维位图上画一条从<span class="math inline">\((x_0,y_0)\)</span>到<span class="math inline">\((x_1,y_1)\)</span>的直线.</p>
<p>直线的两点式为: <span class="math display">\[
\frac{y - y_0}{y_1 - y_0} = \frac{x - x_0}{x_1 - x_0}
\]</span> 因而对任一点<span class="math inline">\(x\)</span>, 有 <span class="math display">\[
y = \frac{x - x_0}{x_1 - x_0} \cdot(y_1 - y_0) + y_0
\]</span> 我们只要枚举<span class="math inline">\(x\)</span>, 计算出每个<span class="math inline">\(x\)</span>对应的<span class="math inline">\(y\)</span>即可画出直线. 需要注意的是, 这个算法默认<span class="math inline">\((x_1,y_1)\)</span>在<span class="math inline">\((x_0,y_0)\)</span>的右上方, 并且绘制时需要枚举<span class="math inline">\(\Delta x,\Delta y\)</span>中较大的一方以保证线段不会断开.</p>
<p>代码如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Drawer::Line</span><span class="params">(<span class="keyword">int</span> x0, <span class="keyword">int</span> y0, <span class="keyword">int</span> x1, <span class="keyword">int</span> y1, TGAColor color)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> flip = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">abs</span>(x0 - x1) &lt; <span class="built_in">abs</span>(y0 - y1))&#123;</span><br><span class="line">        flip = <span class="number">1</span>;</span><br><span class="line">        std::<span class="built_in">swap</span>(x0,y0),std::<span class="built_in">swap</span>(x1,y1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(x0 &gt; x1)&#123;</span><br><span class="line">        std::<span class="built_in">swap</span>(x0,x1),std::<span class="built_in">swap</span>(y0,y1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> x = x0;x &lt;= x1;x++)&#123;</span><br><span class="line">        <span class="keyword">double</span> t = (<span class="keyword">double</span>)(x - x0)/(x1 - x0);</span><br><span class="line">        <span class="keyword">int</span> y = t * (y1 - y0) + y0;</span><br><span class="line">        <span class="keyword">if</span>(!flip)<span class="built_in">set</span>(x,y,color);</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">set</span>(y,x,color);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="bresenham直线算法">Bresenham直线算法</h2>
<p>朴素算法已经能够满足绘图需要, 但是使用了浮点乘法除法, 效率很低.</p>
<p>我们设直线的斜率<span class="math inline">\(k = \frac{y_1 - y_0}{x_1 - x_0}\)</span>, 有 <span class="math display">\[
y = (x - x_0) \cdot k + y_0
\]</span> 我们假设当前画笔所在位置的是<span class="math inline">\((x,y_c)\)</span>, 误差为<span class="math inline">\(E = y- y_c\)</span>. 当<span class="math inline">\(x\)</span>加<span class="math inline">\(1\)</span>时, <span class="math inline">\(E\)</span>增加<span class="math inline">\(k\)</span>. 当<span class="math inline">\(E \ge \frac{1}{2}\)</span>时, 我们需要将<span class="math inline">\(y_c\)</span>加或减<span class="math inline">\(1\)</span>同时<span class="math inline">\(E\)</span>减去<span class="math inline">\(1\)</span>. 这样便避免了每次都要进行的浮点除法运算.</p>
<p>具体来说, 我们只需将不等式的两边乘上<span class="math inline">\(2 \cdot (x_1 - x_0)\)</span>即可. 此时误差每次增加<span class="math inline">\(2 \cdot (y_1 - y_0)\)</span>. 当<span class="math inline">\(E \ge (x_1 - x_0)\)</span>时需要将<span class="math inline">\(y_c\)</span>加或减<span class="math inline">\(1\)</span>同时<span class="math inline">\(E\)</span>减去<span class="math inline">\(2 \cdot (x_1 - x_0)\)</span>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Drawer::Line</span><span class="params">(<span class="keyword">int</span> x0, <span class="keyword">int</span> y0, <span class="keyword">int</span> x1, <span class="keyword">int</span> y1, TGAColor color)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> flip = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">abs</span>(x0 - x1) &lt; <span class="built_in">abs</span>(y0 - y1))&#123;</span><br><span class="line">        flip = <span class="number">1</span>;</span><br><span class="line">        std::<span class="built_in">swap</span>(x0,y0),std::<span class="built_in">swap</span>(x1,y1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(x0 &gt; x1)&#123;</span><br><span class="line">        std::<span class="built_in">swap</span>(x0,x1),std::<span class="built_in">swap</span>(y0,y1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> dx = x1 - x0,dy = y1 - y0;</span><br><span class="line">    <span class="keyword">int</span> e = <span class="number">0</span>,de = <span class="number">2</span>*<span class="built_in">abs</span>(dy);</span><br><span class="line">    <span class="keyword">int</span> y = y0;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> x = x0;x &lt;= x1;x++)&#123;</span><br><span class="line">        e += de;</span><br><span class="line">        <span class="keyword">if</span>(e &gt;= dx) &#123;</span><br><span class="line">            e -= dx*<span class="number">2</span>;</span><br><span class="line">            y += (dy &gt; <span class="number">0</span>?<span class="number">1</span>:<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!flip)<span class="built_in">set</span>(x,y,color);</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">set</span>(y,x,color);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="step-2画一个三角形">Step 2：画一个三角形</h1>
<h2 id="扫描线法">扫描线法</h2>
<p>我们先用一种十分古老的方法来画一个三角形: 用水平或者竖直的线一行一行地绘制.</p>
<p>在绘制前, 先对三角形的三个顶点按横坐标递增进行排序, 然后标号为<span class="math inline">\(P_0,P_1,P_2\)</span>(以下默认左下角为坐标原点). 同时将边<span class="math inline">\(P_0P_1\)</span>标为<span class="math inline">\(L_0\)</span>, <span class="math inline">\(P_1P_2\)</span>标为<span class="math inline">\(L_1\)</span>, <span class="math inline">\(P_2P_3\)</span>标为<span class="math inline">\(L_2\)</span>, 如图:</p>
<p><img src="E:\Github\hexo\source\_posts\demo-render.assets\image-20220501154945120.png" alt="image-20220501154945120" style="zoom:50%;" /></p>
<p>标号后的三角形可按<span class="math inline">\(x = x_1\)</span>​这条直线分割成两部分. 对两部分分别进行绘制即可. 注意处理一下斜率不存在时的细节.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Drawer::Triangle</span><span class="params">(Vec2i t0, Vec2i t1, Vec2i t2, TGAColor color)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x0,y0,x1,y1,x2,y2;</span><br><span class="line">    std::vector&lt;std::pair&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt; &gt;top = &#123;&#123;t0.u,t0.v&#125;,&#123;t1.u,t1.v&#125;,&#123;t2.u,t2.v&#125;&#125;;</span><br><span class="line">    std::<span class="built_in">sort</span>(top.<span class="built_in">begin</span>(),top.<span class="built_in">end</span>());</span><br><span class="line">    std::<span class="built_in">tie</span>(x0,y0) = top[<span class="number">0</span>];</span><br><span class="line">    std::<span class="built_in">tie</span>(x1,y1) = top[<span class="number">1</span>];</span><br><span class="line">    std::<span class="built_in">tie</span>(x2,y2) = top[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> mx = std::<span class="built_in">max</span>(x1,x2);</span><br><span class="line">    <span class="keyword">double</span> k0 = (<span class="keyword">double</span>)(y1 - y0)/(x1 == x0?<span class="number">1</span>:x1 - x0);</span><br><span class="line">    <span class="keyword">double</span> k1 = (<span class="keyword">double</span>)(y2 - y1)/(x2 == x1?<span class="number">1</span>:x2 - x1);</span><br><span class="line">    <span class="keyword">double</span> k2 = (<span class="keyword">double</span>)(y2 - y0)/(x2 == x0?<span class="number">1</span>:x2 - x0);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> x = x0;x &lt;= x2;x++)&#123;</span><br><span class="line">        <span class="keyword">int</span> yc2 = (x - x0) * k2 + y0;</span><br><span class="line">        <span class="keyword">if</span>(x &lt;= x1)&#123;</span><br><span class="line">            <span class="keyword">int</span> yc0 = (x - x0) * k0 + y0;</span><br><span class="line">            <span class="built_in">Line</span>(x,yc0,x,yc2,color);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">int</span> yc1 = (x - x1) * k1 + y1;</span><br><span class="line">            <span class="built_in">Line</span>(x,yc1,x,yc2,color);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="重心坐标系">重心坐标系</h2>
<h3 id="一般定义">一般定义</h3>
<p>设<span class="math inline">\(V_1,...,V_n\)</span>是<span class="math inline">\(n\)</span>维向量空间<span class="math inline">\(V\)</span>中<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Simplex">单纯形</a>的顶点, 对于<span class="math inline">\(V\)</span>中任意一点<span class="math inline">\(P\)</span>, 有 <span class="math display">\[
(\sum_{i = 1}^n \lambda_i)\cdot P = \sum_{i = 1}^n \lambda_i \cdot V_i
\]</span> 则系数<span class="math inline">\(\lambda_1,...,\lambda_n\)</span>称为<span class="math inline">\(P\)</span>关于<span class="math inline">\(V_1,...V_n\)</span>的重心坐标. 一般规定<span class="math inline">\(\sum_{i = 1}^n \lambda_i = 1\)</span>, 此时称为<strong>正规化</strong>的重心坐标. 以下讨论的重心坐标均为正规化的.</p>
<h3 id="二维平面中的重心坐标系">二维平面中的重心坐标系</h3>
<h4 id="定义">定义</h4>
<p>二维平面上, 单纯形为三角形. 假设给出一三角形<span class="math inline">\(\Delta ABC\)</span>和三角形所在平面上的一点<span class="math inline">\(P\)</span>, 则<span class="math inline">\(P\)</span>可被如下重心坐标表示: <span class="math display">\[
P = \alpha A + \beta B + \gamma C
\]</span> 考虑<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/144360079">下图(来源见链接)</a>:</p>
<p><img src="https://pic2.zhimg.com/80/v2-34f542500eb2b8b4679dc351609398ad_720w.jpg" alt="img" style="zoom: 50%;" /></p>
<p>将<span class="math inline">\(\vec{AB},\vec{AC}\)</span>作为坐标系, 可以得到 <span class="math display">\[
\begin{align}
P =&amp; A + \beta(\vec{AB}) + \gamma(\vec{AC})\\
=&amp; A + \beta(B - A) + \gamma(C - A)\\
=&amp; (1 - \beta - \gamma)A + \beta B + \gamma C
\end{align}
\]</span> 这样便可以从坐标系的角度来解释重心坐标, 同时能得到 <span class="math display">\[
\alpha = 1 - \beta - \gamma
\]</span></p>
<h4 id="求解解方程组">求解:解方程组</h4>
<p>将点带入重心坐标的定义, 可以得到: <span class="math display">\[
\left \{
\begin{array}{cccc} 
   x_p = (1 - \beta - \gamma) x_a + \beta x_b + \gamma x_c \\
   y_p = (1 - \beta - \gamma) y_a + \beta y_b + \gamma y_c
\end{array}
\right.
\]</span> 提取出<span class="math inline">\(\beta \space \gamma\)</span>: <span class="math display">\[
\left \{
\begin{array}{cccc}
x_p - x_a = \beta(x_b - x_a) + \gamma (x_c - x_a)\\
y_p - y_a = \beta(y_b - y_a) + \gamma (y_c - y_a)
\end{array}
\right.
\]</span> 转化为矩阵形式: <span class="math display">\[
\left[
\begin{array}{}
    x_b - x_a &amp; x_c - x_a\\
    y_b - y_a &amp; y_c - y_a
\end{array}
\right]
\left[
\begin{array}{}
\beta \\
\gamma
\end{array}
\right]
=
\left[
\begin{array}{}
x_p - x_a\\
y_p - y_a
\end{array}
\right]
\]</span> 这样便可求解出<span class="math inline">\(\beta \space \gamma\)</span>进而求出<span class="math inline">\(\alpha\)</span></p>
<h4 id="求解向量叉积">求解:向量叉积</h4>
<p>把坐标系的表达式变换一下: <span class="math display">\[
\beta \vec{AB} + \gamma \vec{AC} + \vec{PA} = 0
\]</span> 拆开后: <span class="math display">\[
\left \{
\begin{array}{cccc} 
\beta\vec{AB}_x + \gamma \vec{AC}_x + \vec{PA}_x = 0\\
\beta\vec{AB}_y + \gamma \vec{AC}_y + \vec{PA}_y = 0
\end{array}
\right.
\]</span> 转化为矩阵形式: <span class="math display">\[
\left[
\begin{array}{}
\beta &amp; \gamma &amp; 1
\end{array}
\right]
\left[
\begin{array}{}
\vec{AB}_x\\
\vec{AC}_x\\
\vec{PA}_x
\end{array}
\right] = 0\\
\left[
\begin{array}{}
\beta &amp; \gamma &amp; 1
\end{array}
\right]
\left[
\begin{array}{}
\vec{AB}_y\\
\vec{AC}_y\\
\vec{PA}_y
\end{array}
\right] = 0\\
\]</span> 从几何意义考虑, 这相当于<span class="math inline">\([\beta ,\gamma,1]\)</span>这个向量和后两个向量分别垂直. 因而我们求出后两个向量的叉积(假设结果为<span class="math inline">\([x,y,z]\)</span>), 则<span class="math inline">\([\frac{x}{z}, \frac{y}{z},1]\)</span>等于<span class="math inline">\([\beta,\gamma,1]\)</span>​.</p>
<p>需要注意<span class="math inline">\(z = 0\)</span>的特殊情况, 根据叉乘的定义, 此时有<span class="math inline">\(\vec{AB}_x \cdot \vec{AC}_y - \vec{AB}_y \cdot \vec{AC}_x = 0\)</span>, 即<span class="math inline">\(\vec{AB} \cdot \vec{AC} = 0\)</span>, 说明<span class="math inline">\(ABC\)</span>三点共线. 这时返回一个任意的负重心坐标即可.</p>
<h4 id="求解三角形面积">求解:三角形面积</h4>
<p><img src="E:\Github\hexo\source\_posts\demo-render.assets\image-20220502193646986.png" alt="image-20220502193646986" style="zoom:50%;" /></p>
<p>如图, 假设三角形面积分别为<span class="math inline">\(S_A,S_B,S_C\)</span>. 则 <span class="math display">\[
\alpha = \frac{S_A}{S_A+S_B+S_C}\\
\beta = \frac{S_B}{S_A+S_B+S_C}\\
\gamma = \frac{S_C}{S_A+S_B+S_C}
\]</span></p>
<h3 id="应用">应用</h3>
<p>重心坐标有很多应用, 在这里我们能用到的结论是: 若<span class="math inline">\(\alpha,\beta,\gamma\)</span>均大于<span class="math inline">\(0\)</span>, 则点<span class="math inline">\(P\)</span>在三角形<span class="math inline">\(\Delta ABC\)</span>的内部; 若<span class="math inline">\(\alpha,\beta,\gamma\)</span>有一个等于<span class="math inline">\(0\)</span>, 则点<span class="math inline">\(P\)</span>在三角形的边上; 若<span class="math inline">\(\alpha,\beta,\gamma\)</span>有两个等于<span class="math inline">\(0\)</span>, 则点<span class="math inline">\(P\)</span>在三角形的顶点上.</p>
<p>在绘图时, 用一个最小的矩形包围住三角形, 再枚举并判断每个点是否在三角形内部即可. 下面的代码采用了向量叉积法:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Vec3f <span class="title">Drawer::Barycentric</span><span class="params">(<span class="keyword">const</span> Vec2i (&amp;vertex)[<span class="number">3</span>],<span class="keyword">const</span> Vec2i &amp; P)</span></span>&#123;</span><br><span class="line">    Vec3f result =  <span class="comment">//cal cross</span></span><br><span class="line">            <span class="built_in">Vec3f</span>(vertex[<span class="number">1</span>].x - vertex[<span class="number">0</span>].x,vertex[<span class="number">2</span>].x - vertex[<span class="number">0</span>].x,vertex[<span class="number">0</span>].x - P.x) ^</span><br><span class="line">            <span class="built_in">Vec3f</span>(vertex[<span class="number">1</span>].y - vertex[<span class="number">0</span>].y,vertex[<span class="number">2</span>].y - vertex[<span class="number">0</span>].y,vertex[<span class="number">0</span>].y - P.y);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">fabs</span>(result.z) &lt; <span class="number">1</span>)<span class="keyword">return</span> <span class="built_in">Vec3f</span>(<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">    result.x /= result.z,result.y /= result.z;</span><br><span class="line">    <span class="keyword">return</span> &#123;(<span class="keyword">float</span>)<span class="number">1.0</span> - result.x - result.y,result.x,result.y&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Drawer::Triangle</span><span class="params">(<span class="keyword">const</span> Vec2i (&amp;vertex)[<span class="number">3</span>],<span class="keyword">const</span> TGAColor &amp; color)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> lx = std::<span class="built_in">max</span>(std::<span class="built_in">min</span>(&#123;vertex[<span class="number">0</span>].x,vertex[<span class="number">1</span>].x,vertex[<span class="number">2</span>].x&#125;),<span class="number">0</span>),rx = std::<span class="built_in">min</span>(std::<span class="built_in">max</span>(&#123;vertex[<span class="number">0</span>].x,vertex[<span class="number">1</span>].x,vertex[<span class="number">2</span>].x&#125;),<span class="built_in">get_width</span>()<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">int</span> ly = std::<span class="built_in">max</span>(std::<span class="built_in">min</span>(&#123;vertex[<span class="number">0</span>].y,vertex[<span class="number">1</span>].y,vertex[<span class="number">2</span>].y&#125;),<span class="number">0</span>),ry = std::<span class="built_in">min</span>(std::<span class="built_in">max</span>(&#123;vertex[<span class="number">0</span>].y,vertex[<span class="number">1</span>].y,vertex[<span class="number">2</span>].y,&#125;),<span class="built_in">get_height</span>()<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> x = lx;x &lt;= rx;x++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> y = ly;y &lt;= ry;y++)&#123;</span><br><span class="line">            Vec3f bary = <span class="built_in">Barycentric</span>(vertex,<span class="built_in">Vec2i</span>(x,y));</span><br><span class="line">            <span class="keyword">bool</span> out = (bary.x &lt; <span class="number">0</span> <span class="keyword">or</span> bary.y &lt; <span class="number">0</span> <span class="keyword">or</span> bary.z &lt; <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span>(!out)<span class="built_in">set</span>(x,y,color);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<a target="_blank" rel="noopener" href="https://github.com/ssloy/tinyrenderer/tree/024ad4619b824f9179c86dc144145e2b8b155f52">tinyrender提供的模型</a>来测试一下我们的三角形绘制程序(先给每个面一个随机颜色):</p>
<p><img src="E:\Github\hexo\source\_posts\demo-render.assets\image-20220502215053686.png" alt="image-20220502215053686" style="zoom:25%;" /></p>
<p>加上一点阴影并剔除背面的三角形:</p>
<p><img src="E:\Github\hexo\source\_posts\demo-render.assets\image-20220502215757516.png" alt="image-20220502215757516" style="zoom:25%;" /></p>
<h1 id="step-3-z-buffer">Step 3 ：z-buffer</h1>
<p>现在我们需要考虑剔除掉不能被我们看见的像素(Step 2通过Back-face culling剔除了一些面, 但是仍然不正确, 例如嘴部整个消失了). z-buffer的思想是维护一个像素点在待渲染平面上的一个距离buffer, 每次用离相机更近的点来剔除已经存在的点. z-buffer的实现非常简单, 下面主要讨论如何求每个点距相机的距离.</p>
<p>首先考虑一维的情形. 假设我们要绘制从<span class="math inline">\(A(x_0,y_0)\)</span>到<span class="math inline">\(B(x_1,y_1)\)</span>的一条线段, 当前绘制到点<span class="math inline">\(P(x,y)\)</span>, 摄像机的视角与<span class="math inline">\(y\)</span>轴的反方向相同:</p>
<p><img src="E:\Github\hexo\source\_posts\demo-render.assets\image-20220503101100866.png" alt="image-20220503101100866" style="zoom:50%;" /></p>
<p>在绘制时我们要通过<span class="math inline">\(x\)</span>坐标计算出<span class="math inline">\(y\)</span>来. 不难得到 <span class="math display">\[
\frac{y - y_0}{y1 - y_0} = \frac{x - x_0}{x_1 - x_0}
\]</span> 我们设<span class="math inline">\(\beta = \frac{x - x_0}{x_1 - x_0}\)</span>, 则有 <span class="math display">\[
y = (1 - \beta)y_0 + \beta y_1
\]</span> 是不是很熟悉? <span class="math inline">\(\alpha = 1 - \beta\)</span>和<span class="math inline">\(\beta\)</span>就是<span class="math inline">\(P\)</span>关于线段<span class="math inline">\(AB\)</span>的重心坐标(一维单纯形是线段). 我们将其推广到二维, 便能求出三角形每个点距离相机的距离<span class="math inline">\(z\)</span>: <span class="math display">\[
z = \alpha z_0+ \beta z_1 + \gamma z_2
\]</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Drawer::Triangle</span><span class="params">(<span class="keyword">const</span> Vec3i (&amp;vertex)[<span class="number">3</span>],<span class="keyword">const</span> TGAColor &amp; color,<span class="keyword">double</span> * zbuffer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">double</span> eps = <span class="number">-1e-6</span>;<span class="comment">//防止三角形接合处有未绘制的点</span></span><br><span class="line">    <span class="keyword">int</span> lx = std::<span class="built_in">max</span>(std::<span class="built_in">min</span>(&#123;vertex[<span class="number">0</span>].x,vertex[<span class="number">1</span>].x,vertex[<span class="number">2</span>].x&#125;),<span class="number">0</span>),rx = std::<span class="built_in">min</span>(std::<span class="built_in">max</span>(&#123;vertex[<span class="number">0</span>].x,vertex[<span class="number">1</span>].x,vertex[<span class="number">2</span>].x&#125;),<span class="built_in">get_width</span>()<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">int</span> ly = std::<span class="built_in">max</span>(std::<span class="built_in">min</span>(&#123;vertex[<span class="number">0</span>].y,vertex[<span class="number">1</span>].y,vertex[<span class="number">2</span>].y&#125;),<span class="number">0</span>),ry = std::<span class="built_in">min</span>(std::<span class="built_in">max</span>(&#123;vertex[<span class="number">0</span>].y,vertex[<span class="number">1</span>].y,vertex[<span class="number">2</span>].y,&#125;),<span class="built_in">get_height</span>()<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> x = lx;x &lt;= rx;x++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> y = ly;y &lt;= ry;y++)&#123;</span><br><span class="line">            Vec3f bary = <span class="built_in">Barycentric</span>(vertex,<span class="built_in">Vec2i</span>(x,y));</span><br><span class="line">            <span class="keyword">if</span>(bary.x &lt; eps <span class="keyword">or</span> bary.y &lt; eps <span class="keyword">or</span> bary.z &lt; eps)<span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">int</span> idx = x + y * <span class="built_in">get_width</span>();</span><br><span class="line">            <span class="keyword">double</span> z = bary.x * vertex[<span class="number">0</span>].z + bary.y * vertex[<span class="number">1</span>].z + bary.z * vertex[<span class="number">2</span>].z;</span><br><span class="line">            <span class="keyword">if</span>(zbuffer[idx] &lt; z)&#123;</span><br><span class="line">                zbuffer[idx] = z;</span><br><span class="line">                <span class="built_in">set</span>(x,y,color);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果如下:</p>
<p><img src="E:\Github\hexo\source\_posts\demo-render.assets\image-20220503104500854.png" alt="image-20220503104500854" style="zoom:25%;" /></p>
<h1 id="step-4-透视投影">Step 4: 透视投影</h1>
<p>这一部分tinyrender讲得很含糊而且不直观, 所以我直接按照GAMES101的内容去实现.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://linkinpony.github.io/2022/03/18/solution-CF1642F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LinkinPony">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I always love dashie">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/18/solution-CF1642F/" class="post-title-link" itemprop="url">[题解]CF1642F - Two Arrays</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-03-18 11:57:47 / Modified: 19:39:21" itemprop="dateCreated datePublished" datetime="2022-03-18T11:57:47+08:00">2022-03-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>感觉这场F比E简单多了= =</p>
<h2 id="题意">题意</h2>
<p>给出一个<span class="math inline">\(n \times m\)</span>的数组 <span class="math inline">\((1 \leq n \leq 10^5,1 \leq m \leq 5)\)</span>. 数组的每一行元素均互不相同, 且每一行有一个权值<span class="math inline">\(w\)</span> <span class="math inline">\((1 \leq w \leq 10^9)\)</span>.</p>
<p>你需要找出不同的两行, 使得这两行在不存在重复元素的同时权值最小. 输出权值, 无解输出<code>-1</code>.</p>
<h2 id="题解">题解</h2>
<p>暴力做需要<span class="math inline">\(O(n^2m)\)</span>.</p>
<p>将行按权值排序, 把每一个元素对应的行用bitset存下来, 0代表非法1代表合法. 再在枚举每行的时候找到第一个不冲突的行更新答案就可以做到<span class="math inline">\(O(\frac{n^2m}{w})\)</span>, 其中<span class="math inline">\(w = 32\)</span>或<span class="math inline">\(64\)</span>​. 但是这样需要<span class="math inline">\(O(\frac{n^2m}{8})\)</span>的空间, 会MLE.</p>
<p>考虑分块. 设块大小为<span class="math inline">\(B\)</span>, 将每个元素按出现次数分类:</p>
<ul>
<li>出现次数大于<span class="math inline">\(B\)</span>, 这部分元素用bitset存下来, 在枚举每行时使用按位与来更新, 时间复杂度<span class="math inline">\(O(\frac{n^2m}{Bw})\)</span>, 空间复杂度<span class="math inline">\(O(\frac{n^2m}{8B})\)</span>.</li>
<li>出现次数小于<span class="math inline">\(B\)</span>, 这部分元素在枚举每行时直接更新, 时间复杂度<span class="math inline">\(O(B^2)\)</span>, 空间复杂度<span class="math inline">\(O(n)\)</span>.</li>
</ul>
<p>(感觉复杂度算的很不对劲啊- - 反正能过)</p>
<p>然后B选一个差不多的大小比如<span class="math inline">\(\sqrt{nm}\)</span>就能过了.</p>
<h2 id="代码">代码</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> endl <span class="meta-string">&#x27;\n&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALL(x) (x).begin(),(x).end()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRINT(___) for(auto ____:(___))&#123;cout &lt;&lt; ____ &lt;&lt; <span class="meta-string">&quot; &quot;</span>;&#125;cout &lt;&lt; endl;</span></span><br><span class="line"><span class="function">mt19937 <span class="title">Rand</span><span class="params">(chrono::steady_clock::now().time_since_epoch().count())</span></span>;</span><br><span class="line"><span class="function">ll <span class="title">Pow</span><span class="params">(ll x,ll d,ll p)</span></span>&#123;ll ta=<span class="number">1</span>;<span class="keyword">if</span>(d==<span class="number">0</span>)<span class="keyword">return</span> <span class="number">1</span>%p;x %= p;ll a=<span class="built_in">Pow</span>(x,d/<span class="number">2</span>,p);ta=a*a%p;<span class="keyword">if</span>(d%<span class="number">2</span>)ta=ta*x%p;<span class="keyword">return</span> ta%p;&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">1e5</span>+<span class="number">10</span>;<span class="comment">//CHANGE IT!</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxm = maxn*<span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> p = <span class="number">1e9</span>+<span class="number">7</span>;<span class="comment">//CHANGE IT!</span></span><br><span class="line"><span class="keyword">int</span> raw[maxn],mp[maxn * <span class="number">5</span>];</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxb = <span class="number">708</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxc = <span class="number">100006</span>;</span><br><span class="line">bitset&lt;maxc&gt;b[maxb + <span class="number">10</span>];</span><br><span class="line">vector&lt;<span class="keyword">int</span>&gt;ban[maxn * <span class="number">5</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span>&#123;</span></span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt;r;</span><br><span class="line">	<span class="keyword">int</span> w;</span><br><span class="line">	<span class="built_in">Node</span>(vector&lt;<span class="keyword">int</span>&gt; r = &#123;&#125;,<span class="keyword">int</span> w = <span class="number">0</span>):<span class="built_in">r</span>(r),<span class="built_in">w</span>(w)&#123;&#125;</span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> Node &amp; x)<span class="keyword">const</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> w &lt; x.w;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;node[maxn];</span><br><span class="line"><span class="keyword">int</span> cnt[maxn * <span class="number">5</span>];</span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	ios::<span class="built_in">sync_with_stdio</span>(<span class="number">0</span>);</span><br><span class="line">	cin.<span class="built_in">tie</span>(<span class="number">0</span>);</span><br><span class="line">	cout.<span class="built_in">setf</span>(ios::fixed,ios::floatfield);</span><br><span class="line">	cout.<span class="built_in">precision</span>(<span class="number">12</span>);	 </span><br><span class="line">	<span class="keyword">int</span> n,m;</span><br><span class="line">	cin &gt;&gt; n &gt;&gt; m;</span><br><span class="line">	map&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt;hsh;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= n;i++)&#123;</span><br><span class="line">		vector&lt;<span class="keyword">int</span>&gt;<span class="built_in">r</span>(m);</span><br><span class="line">		<span class="keyword">int</span> w;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; m;j++)&#123;</span><br><span class="line">			cin &gt;&gt; r[j];</span><br><span class="line">			hsh[r[j]]++;</span><br><span class="line">		&#125;</span><br><span class="line">		cin &gt;&gt; w;</span><br><span class="line">		node[i] = <span class="built_in">Node</span>(r,w);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> tmp = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">auto</span> &amp; it:hsh)&#123;</span><br><span class="line">		cnt[tmp] = it.second;</span><br><span class="line">		it.second = tmp++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">sort</span>(node+<span class="number">1</span>,node+n+<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">int</span> ans = <span class="number">2e9</span> + <span class="number">10</span>,idx = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= n;i++)&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; m;j++)&#123;</span><br><span class="line">			<span class="keyword">int</span> &amp; v = node[i].r[j];</span><br><span class="line">			v = hsh[v];</span><br><span class="line">			<span class="keyword">if</span>(cnt[v] &gt; maxb)&#123;</span><br><span class="line">				<span class="keyword">if</span>(!mp[v])&#123;</span><br><span class="line">					b[idx].<span class="built_in">set</span>();</span><br><span class="line">					mp[v] = idx++;</span><br><span class="line">				&#125;</span><br><span class="line">				b[mp[v]].<span class="built_in">reset</span>(i);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> ban[v].<span class="built_in">push_back</span>(i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= n;i++)&#123;</span><br><span class="line">		bitset&lt;maxc&gt;vai;</span><br><span class="line">		vai.<span class="built_in">set</span>();</span><br><span class="line">		vai.<span class="built_in">reset</span>(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; m;j++)&#123;</span><br><span class="line">			<span class="keyword">int</span> v = node[i].r[j];</span><br><span class="line">			<span class="keyword">if</span>(cnt[v] &gt; maxb)&#123;</span><br><span class="line">				vai &amp;= b[mp[v]];</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="keyword">for</span>(<span class="keyword">int</span> x:ban[v])vai.<span class="built_in">reset</span>(x);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> x = vai._Find_first();</span><br><span class="line">		<span class="keyword">if</span>(x &lt;= n)ans = <span class="built_in">min</span>(ans,node[i].w + node[x].w);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(ans == <span class="number">2e9</span>+<span class="number">10</span>)ans = <span class="number">-1</span>;</span><br><span class="line">	cout &lt;&lt; ans;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://linkinpony.github.io/2022/03/11/solution-Gym103495-H/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LinkinPony">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I always love dashie">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/11/solution-Gym103495-H/" class="post-title-link" itemprop="url">[题解]Gym103495-H Reverse the String</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-11 10:46:33" itemprop="dateCreated datePublished" datetime="2022-03-11T10:46:33+08:00">2022-03-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-03-18 11:56:22" itemprop="dateModified" datetime="2022-03-18T11:56:22+08:00">2022-03-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>中规中矩的字符串题.</p>
<h2 id="题意">题意</h2>
<p>给出一个字符串<span class="math inline">\(s\)</span>, 你可以选取<span class="math inline">\(s\)</span>的任意子串将其翻转得到<span class="math inline">\(s&#39;\)</span>, 该操作最多进行一次. 求字典序最小的<span class="math inline">\(s&#39;\)</span>.</p>
<p><span class="math inline">\(|s| \leq 10^5, \sum |s| \leq 1.5 \cdot 10 ^ 6\)</span></p>
<h2 id="题解">题解</h2>
<p>以下字符串的下标均从<span class="math inline">\(0\)</span>开始. <span class="math inline">\(lcp(s,t)\)</span>代表<span class="math inline">\(s\)</span>和<span class="math inline">\(t\)</span>的最长公共前缀. <span class="math inline">\(rev(s)\)</span>表示将<span class="math inline">\(s\)</span>翻转后的字符串.</p>
<h3 id="part-1优化做法">part 1：优化做法</h3>
<p>设<span class="math inline">\(n = |s|\)</span>, 朴素的暴力需要至少<span class="math inline">\(O(n^2)\)</span>​来枚举翻转子串的两个端点<span class="math inline">\(L,R\)</span>. 我们需要想办法固定住其中的一个端点.</p>
<p>首先尝试放开限制, 把翻转变成任意排列. 这样将<span class="math inline">\(s\)</span>排序后得到的<span class="math inline">\(s&#39;\)</span>一定是最优的. 记这样的<span class="math inline">\(s&#39;\)</span>为<span class="math inline">\(t\)</span>.</p>
<p>回到原题, 容易看出, <span class="math inline">\(s\)</span>和<span class="math inline">\(t\)</span>的最长公共前缀部分无论我们如何操作都不可能再让字典序变小, 而在这之后的部分是有可能减小字典序的. 且因为字典序的性质(比较第一个不相同的字符), 我们必须尝试让<span class="math inline">\(s&#39;\)</span>和<span class="math inline">\(t\)</span>不同的第一个字符最小. 因此<span class="math inline">\(L = lcp(s,t)\)</span>.</p>
<h3 id="part-2快速比较两字符串大小">part 2：快速比较两字符串大小</h3>
<p>设当前的最优答案为<span class="math inline">\(ans\)</span>, 在固定了<span class="math inline">\(L\)</span>之后, 只需<span class="math inline">\(O(n)\)</span>枚举<span class="math inline">\(R\)</span>, 并快速比较<span class="math inline">\(ans\)</span>和<span class="math inline">\(s&#39;\)</span>的大小即可. 这里可以用<span class="math inline">\(lcp\)</span>来比较两个字符串的大小.</p>
<p>设需要比较<span class="math inline">\(A = s[a...b]\)</span>和<span class="math inline">\(B = s[c...d]\)</span>的关系. 若<span class="math inline">\(lcp(a,c) \ge \min(|A|,|B|)\)</span>,则<span class="math inline">\(A &lt; B\)</span>等价于<span class="math inline">\(|A| &lt; |B|\)</span> 否则, <span class="math inline">\(A &lt; B\)</span>等价于<span class="math inline">\(rank[a] &lt; rank[c]\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">CompString</span><span class="params">(<span class="keyword">int</span> s1,<span class="keyword">int</span> len1,<span class="keyword">int</span> s2,<span class="keyword">int</span> len2)</span></span>&#123;</span><br><span class="line">    	<span class="comment">//s:子串起始位置 len:子串长度</span></span><br><span class="line">		<span class="keyword">int</span> tlcp = (s1 == s2?<span class="built_in">min</span>(len1,len2):<span class="built_in">LCP</span>(s1,s2));</span><br><span class="line">		<span class="keyword">if</span>(tlcp &gt;= <span class="built_in">min</span>(len1,len2))&#123;</span><br><span class="line">			<span class="keyword">return</span> len1 &lt; len2?<span class="number">-1</span>:(len1 == len2?<span class="number">0</span>:<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">return</span> c[s1] &lt; c[s2]?<span class="number">-1</span>:(c[s1] == c[s2]?<span class="number">0</span>:<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>注意: 可以只用<span class="math inline">\(lcp\)</span>来比较字符串大小(这样就可以用hash等方法来求<span class="math inline">\(lcp\)</span>而不用写SA). 只要把上面的第6行替换为</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">return</span> s[s1 + tlcp] &lt; s[s2 + tlcp]?<span class="number">-1</span>:(s[s1 + tlcp] == s[s2 + tlcp]?<span class="number">0</span>:<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>即可.</p>
<h3 id="part-3-细节部分">part 3 ：细节部分</h3>
<p>首先将整个翻转后的<span class="math inline">\(s\)</span>拼接在原字符串后, 中间用特殊字符隔开, 例如<code>u = s + "$" + rev(s)</code>. 再使用后缀数组处理<span class="math inline">\(u\)</span>. 这样在原串中位置为<span class="math inline">\(i\)</span>的字符, 在反串中的位置就是<span class="math inline">\(2*n - i\)</span>.</p>
<p>假设当前枚举到<span class="math inline">\(R\)</span>, 最优答案为<span class="math inline">\(R&#39;\)</span>, 如下图:</p>
<p><img src="https://raw.githubusercontent.com/LinkinPony/hexo_pic_bed/master/img/image-20220318113847339.png" alt="image-20220318113847339" style="zoom:33%;" /></p>
<p>我们需要比较的是<span class="math inline">\(s[L,R&#39;-1] + rev(s[R&#39;,R])\)</span>和<span class="math inline">\(rev(s[L,R])\)</span>的大小, 如果后者更小则更新答案. 为了方便比较, 可以将每段字符划分成AB两段:</p>
<p><img src="https://raw.githubusercontent.com/LinkinPony/hexo_pic_bed/master/img/image-20220318114006215.png" alt="image-20220318114006215" style="zoom:33%;" /></p>
<p>现在需要比较的就是<span class="math inline">\(rev(A_1) + B_1\)</span>和<span class="math inline">\(rev(A_2) + rev(B_2)\)</span>的大小. 由于A, B长度分别相等, 可以用part2的方法分别比较<span class="math inline">\(rev(A_1)\)</span>与<span class="math inline">\(rev(A_2)\)</span>, <span class="math inline">\(B_1\)</span>与<span class="math inline">\(rev(B_2)\)</span>的大小</p>
<p>每段的(起始位置,长度)可以通过简单推导得到:</p>
<p><span class="math inline">\(rev(A_1)\)</span>: <span class="math inline">\((2*n - R&#39;,R&#39; - L + 1)\)</span></p>
<p><span class="math inline">\(rev(A2)\)</span>: <span class="math inline">\((2*n - R,R - L + 1)\)</span></p>
<p><span class="math inline">\(B_1\)</span>: <span class="math inline">\((R&#39; + 1,i - R&#39;)\)</span></p>
<p><span class="math inline">\(rev(B_2)\)</span>: <span class="math inline">\((2*n - R + R&#39; - L + 1,i - R&#39;)\)</span></p>
<p>其他细节见代码. 时间复杂度<span class="math inline">\(O(n \log n)\)</span>. jls好像有<span class="math inline">\(O(n)\)</span>做法, 有没有好哥哥教教QAQ</p>
<h2 id="代码">代码</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC optimize(<span class="meta-string">&quot;Ofast,unroll-loops&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC target(<span class="meta-string">&quot;avx,avx2,sse,sse2&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> endl <span class="meta-string">&#x27;\n&#x27;</span></span></span><br><span class="line"><span class="function">mt19937 <span class="title">Rand</span><span class="params">(chrono::steady_clock::now().time_since_epoch().count())</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">2e5</span>+<span class="number">10</span>;<span class="comment">//CHANGE IT!</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxm = maxn*<span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> p = <span class="number">1e9</span>+<span class="number">7</span>;<span class="comment">//CHANGE IT!</span></span><br><span class="line"><span class="function">ll <span class="title">Pow</span><span class="params">(ll x,ll d,ll p)</span></span>&#123;ll ta=<span class="number">1</span>;<span class="keyword">if</span>(d==<span class="number">0</span>)<span class="keyword">return</span> <span class="number">1</span>%p;x %= p;ll a=<span class="built_in">Pow</span>(x,d/<span class="number">2</span>,p);ta=a*a%p;<span class="keyword">if</span>(d%<span class="number">2</span>)ta=ta*x%p;<span class="keyword">return</span> ta%p;&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span>&#123;</span></span><br><span class="line">	<span class="keyword">int</span> a,b;</span><br><span class="line">	<span class="built_in">Node</span>(<span class="keyword">int</span> a = <span class="number">0</span>,<span class="keyword">int</span> b = <span class="number">0</span>):<span class="built_in">a</span>(a),<span class="built_in">b</span>(b)&#123;&#125;</span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> Node &amp; x)&#123;</span><br><span class="line">		<span class="keyword">return</span> a == x.a?b &lt; x.b:a &lt; x.a;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;; </span><br><span class="line"><span class="keyword">int</span> lcp[maxn],ST[maxn][<span class="number">20</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SA</span>&#123;</span></span><br><span class="line">	string s;</span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt;sa,c;</span><br><span class="line">	<span class="built_in">SA</span>(string s = <span class="string">&quot;&quot;</span>):<span class="built_in">s</span>(s)&#123;</span><br><span class="line">		sa.<span class="built_in">clear</span>(),c.<span class="built_in">clear</span>();</span><br><span class="line">		s += <span class="string">&#x27;$&#x27;</span>;</span><br><span class="line">		n = s.<span class="built_in">size</span>();</span><br><span class="line">		sa.<span class="built_in">assign</span>(n,<span class="number">0</span>);</span><br><span class="line">		c.<span class="built_in">assign</span>(n,<span class="number">0</span>); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">count_sort</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp; sa,vector&lt;<span class="keyword">int</span>&gt; &amp; c)</span></span>&#123;</span><br><span class="line">		vector&lt;<span class="keyword">int</span>&gt;<span class="built_in">pos</span>(n),<span class="built_in">cnt</span>(n),<span class="built_in">sa_new</span>(n);</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> x:c)cnt[x]++;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt; n;i++)pos[i] = pos[i<span class="number">-1</span>] + cnt[i<span class="number">-1</span>];</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> x:sa)&#123;</span><br><span class="line">			<span class="keyword">int</span> d = c[x];</span><br><span class="line">			sa_new[pos[d]] = x;</span><br><span class="line">			pos[d]++;</span><br><span class="line">		&#125;</span><br><span class="line">		sa = sa_new;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cal</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">//init</span></span><br><span class="line">		&#123;</span><br><span class="line">			vector&lt;Node&gt;<span class="built_in">A</span>(n);</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n;i++)A[i] = <span class="built_in">Node</span>(s[i],i);</span><br><span class="line">			<span class="built_in">sort</span>(A.<span class="built_in">begin</span>(),A.<span class="built_in">end</span>());</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n;i++)sa[i] = A[i].b;</span><br><span class="line">			c[sa[<span class="number">0</span>]] = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt; n;i++)&#123;</span><br><span class="line">				c[sa[i]] = c[sa[i<span class="number">-1</span>]] + (A[i].a != A[i<span class="number">-1</span>].a);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span>((<span class="number">1</span>&lt;&lt;k) &lt; n)&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n;i++)sa[i] = (sa[i] - (<span class="number">1</span>&lt;&lt;k) + n)%n;</span><br><span class="line">			<span class="built_in">count_sort</span>(sa,c);</span><br><span class="line">			vector&lt;<span class="keyword">int</span>&gt;<span class="built_in">c_new</span>(n);</span><br><span class="line">			c_new[sa[<span class="number">0</span>]] = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt; n;i++)&#123;</span><br><span class="line">				pair&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt;now = &#123;c[sa[i]],c[(sa[i] + (<span class="number">1</span>&lt;&lt;k)) % n]&#125;;</span><br><span class="line">				pair&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt;prev = &#123;c[sa[i<span class="number">-1</span>]],c[(sa[i<span class="number">-1</span>] + (<span class="number">1</span>&lt;&lt;k)) % n]&#125;;</span><br><span class="line">				c_new[sa[i]] = c_new[sa[i<span class="number">-1</span>]] + (now != prev);</span><br><span class="line">			&#125;</span><br><span class="line">			k++;</span><br><span class="line">			c = c_new;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ST_init</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= n;i++)ST[i][<span class="number">0</span>] = lcp[i];</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>;(<span class="number">1</span>&lt;&lt;j) &lt;= n;j++)</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i + (<span class="number">1</span>&lt;&lt;j) <span class="number">-1</span> &lt;= n;i++)</span><br><span class="line">				ST[i][j] = <span class="built_in">min</span>(ST[i][j - <span class="number">1</span>],ST[i + (<span class="number">1</span>&lt;&lt;(j - <span class="number">1</span>))][j - <span class="number">1</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">LCP</span><span class="params">(<span class="keyword">int</span> L,<span class="keyword">int</span> R)</span></span>&#123;</span><br><span class="line">		L = c[L],R = c[R];</span><br><span class="line">		<span class="keyword">if</span>(L &gt; R)<span class="built_in">swap</span>(L,R);</span><br><span class="line">		L++;</span><br><span class="line">		<span class="keyword">int</span> k = <span class="built_in">log2</span>(R - L + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">min</span>(ST[L][k],ST[R - (<span class="number">1</span>&lt;&lt;k) + <span class="number">1</span>][k]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">getlcp</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n<span class="number">-1</span>;i++)&#123;</span><br><span class="line">			<span class="keyword">int</span> j = sa[c[i] - <span class="number">1</span>];</span><br><span class="line">			<span class="keyword">while</span>(s[i+k] == s[j+k])k++;</span><br><span class="line">			lcp[c[i]] = k;</span><br><span class="line">			<span class="keyword">if</span>(k)k--;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">ST_init</span>();</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">CompString</span><span class="params">(<span class="keyword">int</span> s1,<span class="keyword">int</span> len1,<span class="keyword">int</span> s2,<span class="keyword">int</span> len2)</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> tlcp = (s1 == s2?<span class="built_in">min</span>(len1,len2):<span class="built_in">LCP</span>(s1,s2));</span><br><span class="line">		<span class="keyword">if</span>(tlcp &gt;= <span class="built_in">min</span>(len1,len2))&#123;</span><br><span class="line">			<span class="keyword">return</span> len1 &lt; len2?<span class="number">-1</span>:(len1 == len2?<span class="number">0</span>:<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">return</span> s[s1 + tlcp] &lt; s[s2 + tlcp]?<span class="number">-1</span>:(s[s1 + tlcp] == s[s2 + tlcp]?<span class="number">0</span>:<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;sa;</span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	ios::<span class="built_in">sync_with_stdio</span>(<span class="number">0</span>);</span><br><span class="line">	cin.<span class="built_in">tie</span>(<span class="number">0</span>);</span><br><span class="line">	cout.<span class="built_in">setf</span>(ios::fixed,ios::floatfield);</span><br><span class="line">	cout.<span class="built_in">precision</span>(<span class="number">12</span>);	 </span><br><span class="line">	<span class="keyword">int</span> __;</span><br><span class="line">	cin &gt;&gt; __;</span><br><span class="line">	<span class="keyword">while</span>(__--)&#123;</span><br><span class="line">		string s;</span><br><span class="line">		cin &gt;&gt; s;</span><br><span class="line">		string u = s;</span><br><span class="line">		<span class="built_in">sort</span>(u.<span class="built_in">begin</span>(),u.<span class="built_in">end</span>());</span><br><span class="line">		<span class="keyword">int</span> L = <span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">int</span> n = s.<span class="built_in">size</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n;i++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(s[i] != u[i])&#123;</span><br><span class="line">				L = i;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(L == <span class="number">-1</span>)&#123;</span><br><span class="line">			cout &lt;&lt; s &lt;&lt; endl;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		u = s;</span><br><span class="line">		<span class="built_in">reverse</span>(u.<span class="built_in">begin</span>(),u.<span class="built_in">end</span>());</span><br><span class="line">		s = s + <span class="string">&quot;$&quot;</span> + u;</span><br><span class="line">		sa = <span class="built_in">SA</span>(s);</span><br><span class="line">		sa.<span class="built_in">cal</span>();</span><br><span class="line">		sa.<span class="built_in">getlcp</span>();</span><br><span class="line">		<span class="keyword">int</span> R = L;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = L;i &lt; n;i++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(sa.<span class="built_in">CompString</span>(L,i - L + <span class="number">1</span>,<span class="number">2</span>*n - i,i - L + <span class="number">1</span>) &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">				<span class="keyword">int</span> x = sa.<span class="built_in">CompString</span>(<span class="number">2</span>*n - R,R - L + <span class="number">1</span>,<span class="number">2</span>*n - i,R - L + <span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span>(x &gt; <span class="number">0</span>)&#123;</span><br><span class="line">					R = i;					</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span>(x == <span class="number">0</span> <span class="keyword">and</span> sa.<span class="built_in">CompString</span>(R + <span class="number">1</span>,i - R,<span class="number">2</span>*n - i + R - L + <span class="number">1</span>,i - R) &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">					R = i;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">reverse</span>(u.<span class="built_in">begin</span>(),u.<span class="built_in">end</span>());</span><br><span class="line">		<span class="built_in">reverse</span>(u.<span class="built_in">begin</span>() + L,u.<span class="built_in">begin</span>() + R + <span class="number">1</span>);</span><br><span class="line">		cout &lt;&lt; u &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://linkinpony.github.io/2022/01/22/solution-CF1625E1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LinkinPony">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I always love dashie">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/22/solution-CF1625E1/" class="post-title-link" itemprop="url">solution-CF1625E1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-22 11:41:15" itemprop="dateCreated datePublished" datetime="2022-01-22T11:41:15+08:00">2022-01-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://linkinpony.github.io/2022/01/19/solution-CF1626E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LinkinPony">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I always love dashie">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/19/solution-CF1626E/" class="post-title-link" itemprop="url">[题解]-CF1626E Black and White Tree</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-19 21:44:29" itemprop="dateCreated datePublished" datetime="2022-01-19T21:44:29+08:00">2022-01-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-02-15 10:40:19" itemprop="dateModified" datetime="2022-02-15T10:40:19+08:00">2022-02-15</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="题意">题意</h2>
<p>给出一个大小为<span class="math inline">\(n\)</span> <span class="math inline">\((n\leq 3 \cdot 10^5)\)</span>的树, 树上每个节点被染成白色或者黑色. 假设当前在点<span class="math inline">\(k\)</span>有一个棋子, 你每次可以选择一个黑点<span class="math inline">\(b\)</span>作为目标点, 将这个棋子向黑点按从<span class="math inline">\(k\)</span>到<span class="math inline">\(b\)</span>的最短路径移动一格(一条边). 连续两次操作选择的黑点不能相同. 对于所有的<span class="math inline">\(k = 1...n\)</span>, 判断该棋子是否能在有限步操作后移动到任意一个黑点. 能移动到则该点答案为<span class="math inline">\(1\)</span>否则为<span class="math inline">\(0\)</span>.</p>
<h2 id="题解">题解</h2>
<p>首先显然黑点和与黑点相邻的白点答案均为<span class="math inline">\(1\)</span>. 对于其它白点, 当且仅当它所在的某条链上有至少两个黑点时它才能移动到黑点上. 这种情况有一个特例:</p>
<figure>
<img src="https://raw.githubusercontent.com/LinkinPony/hexo_pic_bed/master/img/image-20220119220348299.png" alt="image-20220119220348299" /><figcaption aria-hidden="true">image-20220119220348299</figcaption>
</figure>
<p>如图, 尽管1不在任意一条有两个黑点的链上, 但它仍然能到达黑点5, 只要交替选择5, 7两个点即可.</p>
<p>为了解决这种特殊情况, 我们把黑点及与黑点相邻的白点缩成一个点(如果有两个相邻的黑点那么显然答案全为1. 如果不进行特判的话就需要把在同一联通分量里的黑点缩成一个点)</p>
<figure>
<img src="https://raw.githubusercontent.com/LinkinPony/hexo_pic_bed/master/img/image-20220119221543385.png" alt="image-20220119221543385" /><figcaption aria-hidden="true">image-20220119221543385</figcaption>
</figure>
<p>缩点之后如图. 这样1便在有两个黑点的链上了.</p>
<p>判断每个点是否在有不少于两个黑点的链上可以用换根dp求. 首先指定一个根<span class="math inline">\(r\)</span>, <span class="math inline">\(siz[u]\)</span>表示以<span class="math inline">\(u\)</span>为根的子树里拥有黑点数最大的链的黑点数目. 换根dp的具体细节见代码中<code>dfs2()</code>. 需要注意的是缩点之后可能不存在<span class="math inline">\(1\)</span>这个点.</p>
<p>时间复杂度<span class="math inline">\(O(n)\)</span>.</p>
<h2 id="代码">代码</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> endl <span class="meta-string">&#x27;\n&#x27;</span></span></span><br><span class="line"><span class="function">mt19937 <span class="title">Rand</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">3e5</span>+<span class="number">10</span>;<span class="comment">//CHANGE IT!</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxm = maxn*<span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> p = <span class="number">1e9</span>+<span class="number">7</span>;<span class="comment">//CHANGE IT!</span></span><br><span class="line"><span class="function">ll <span class="title">Pow</span><span class="params">(ll x,ll d,ll p)</span></span>&#123;ll ta=<span class="number">1</span>;<span class="keyword">if</span>(d==<span class="number">0</span>)<span class="keyword">return</span> <span class="number">1</span>%p;x %= p;ll a=<span class="built_in">Pow</span>(x,d/<span class="number">2</span>,p);ta=a*a%p;<span class="keyword">if</span>(d%<span class="number">2</span>)ta=ta*x%p;<span class="keyword">return</span> ta%p;&#125;</span><br><span class="line">vector&lt;<span class="keyword">int</span>&gt;G[maxn],G2[maxn];</span><br><span class="line"><span class="keyword">int</span> cli[maxn],w[maxn],ans[maxn],siz[maxn];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pre</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> fa,<span class="keyword">int</span> r)</span></span>&#123;</span><br><span class="line">	cli[u] = r;</span><br><span class="line">	ans[u] = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(r != u)w[r] += w[u];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> v:G2[u])&#123;</span><br><span class="line">		<span class="keyword">if</span>(v == fa)<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span>(w[u] <span class="keyword">and</span> !ans[v])<span class="built_in">pre</span>(v,u,r);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> fa)</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> v:G[u])&#123;</span><br><span class="line">		<span class="keyword">if</span>(v == fa)<span class="keyword">continue</span>;</span><br><span class="line">		<span class="built_in">dfs</span>(v,u);</span><br><span class="line">		siz[u] = <span class="built_in">max</span>(siz[u],siz[v]);</span><br><span class="line">	&#125;</span><br><span class="line">	siz[u] += w[u];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs2</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> fa,<span class="keyword">int</span> res)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> tot = <span class="number">0</span>,mx1 = <span class="number">0</span>,mx2 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> v:G[u])&#123;</span><br><span class="line">		<span class="keyword">if</span>(v == fa)<span class="keyword">continue</span>;</span><br><span class="line">		tot = <span class="built_in">max</span>(tot,siz[v]);</span><br><span class="line">		<span class="keyword">if</span>(siz[v] &gt;= mx1)&#123;</span><br><span class="line">			mx2 = mx1;</span><br><span class="line">			mx1 = siz[v];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(siz[v] &gt; mx2)mx2 = siz[v];</span><br><span class="line">	&#125;</span><br><span class="line">	tot = <span class="built_in">max</span>(tot,res) + w[u];</span><br><span class="line">	<span class="keyword">if</span>(res &gt;= mx1)&#123;</span><br><span class="line">		mx2 = mx1;</span><br><span class="line">		mx1 = res;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(res &gt; mx2)mx2 = res;</span><br><span class="line">	<span class="keyword">if</span>(tot &gt; <span class="number">1</span>)ans[u] = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> v:G[u])&#123;</span><br><span class="line">		<span class="keyword">if</span>(v == fa)<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">int</span> rw = w[u] + (mx1 == siz[v]?mx2:mx1);</span><br><span class="line">		<span class="built_in">dfs2</span>(v,u,rw);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	ios::<span class="built_in">sync_with_stdio</span>(<span class="number">0</span>);</span><br><span class="line">	cin.<span class="built_in">tie</span>(<span class="number">0</span>);</span><br><span class="line">	cout.<span class="built_in">setf</span>(ios::fixed,ios::floatfield);</span><br><span class="line">	cout.<span class="built_in">precision</span>(<span class="number">12</span>);	 </span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	cin &gt;&gt; n;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= n;i++)cin &gt;&gt; w[i],cli[i] = i;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt; n;i++)&#123;</span><br><span class="line">		<span class="keyword">int</span> f,t;</span><br><span class="line">		cin &gt;&gt; f &gt;&gt; t;</span><br><span class="line">		G2[f].<span class="built_in">push_back</span>(t);</span><br><span class="line">		G2[t].<span class="built_in">push_back</span>(f);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= n;i++)<span class="keyword">if</span>(w[i] <span class="keyword">and</span> cli[i] == i)<span class="built_in">pre</span>(i,<span class="number">-1</span>,i);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> u = <span class="number">1</span>;u &lt;= n;u++)&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> v:G2[u])&#123;</span><br><span class="line">			<span class="keyword">if</span>(cli[u] == cli[v])<span class="keyword">continue</span>;</span><br><span class="line">			G[cli[u]].<span class="built_in">push_back</span>(cli[v]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= n;i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(cli[i] == i)&#123;</span><br><span class="line">			<span class="built_in">dfs</span>(i,<span class="number">-1</span>);</span><br><span class="line">			<span class="built_in">dfs2</span>(i,<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= n;i++)cout &lt;&lt; ans[i] &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>$$</p>
<p>$$</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://linkinpony.github.io/2022/01/13/solution-CF1625D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LinkinPony">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I always love dashie">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/13/solution-CF1625D/" class="post-title-link" itemprop="url">[题解]CF1625D-Binary Spiders</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-01-13 14:44:54 / Modified: 19:34:26" itemprop="dateCreated datePublished" datetime="2022-01-13T14:44:54+08:00">2022-01-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="题意">题意</h2>
<p>给出<span class="math inline">\(n\)</span>个数<span class="math inline">\(a_i\)</span>, 和一个整数<span class="math inline">\(k\)</span>. 从这<span class="math inline">\(n\)</span>个数中选出尽可能多的数, 使得它们之间任意两者按位异或后大于等于<span class="math inline">\(k\)</span>. 输出数字的个数和下标, 如果不存在则输出<span class="math inline">\(-1\)</span>.</p>
<p><span class="math inline">\(2 \le n \le 3 \cdot 10^5, 0 \leq a_i,k \leq 2^{30} - 1\)</span></p>
<h2 id="题解">题解</h2>
<p>设<span class="math inline">\(k\)</span>的最高位是第<span class="math inline">\(h\)</span>位. 首先会很自然的想到——如果把每个数位数小于等于<span class="math inline">\(h\)</span>的部分变为0, 按此分类, 从每种里选出一个数字加入答案里一定合法. 因为任意两个数字异或后都至少有一个高于<span class="math inline">\(h\)</span>的位为<span class="math inline">\(1\)</span>. 以样例<span class="math inline">\(k = 8(1000)\)</span>为例:</p>
<table>
<thead>
<tr class="header">
<th>原始</th>
<th>2(10)</th>
<th>8(1000)</th>
<th>4(100)</th>
<th>16(10000)</th>
<th>10(1010)</th>
<th>14(1110)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>处理后组别</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>16(10000)</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>此时我们选择<span class="math inline">\(16\)</span>, 再从<span class="math inline">\(2,8,4,10,14\)</span>里任选一个都能组成一个解，但它不是最优的: 例如在<span class="math inline">\(0\)</span>这一组里选择<span class="math inline">\(2\)</span>和<span class="math inline">\(10\)</span>加入答案也是合法解.</p>
<p>进一步思考可以发现, 在每一组里有可能可以选择两个数字且最多只能选择两个. 如果选择了超过两个数字, 那么至少有两个数字在第<span class="math inline">\(h\)</span>位上是一样的, 这会导致异或后的结果小于<span class="math inline">\(k\)</span>. 使用Trie判断是否有解即可.</p>
<p>注意需要特判<span class="math inline">\(k = 0\)</span>的情况.</p>
<h2 id="代码">代码</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> endl <span class="meta-string">&#x27;\n&#x27;</span></span></span><br><span class="line"><span class="function">mt19937 <span class="title">Rand</span><span class="params">(chrono::steady_clock::now().time_since_epoch().count())</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">3e5</span>+<span class="number">10</span>;<span class="comment">//CHANGE IT!</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxm = maxn*<span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxc = <span class="number">1e7</span>+<span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> p = <span class="number">1e9</span>+<span class="number">7</span>;<span class="comment">//CHANGE IT!</span></span><br><span class="line"><span class="function">ll <span class="title">Pow</span><span class="params">(ll x,ll d,ll p)</span></span>&#123;ll ta=<span class="number">1</span>;<span class="keyword">if</span>(d==<span class="number">0</span>)<span class="keyword">return</span> <span class="number">1</span>%p;x %= p;ll a=<span class="built_in">Pow</span>(x,d/<span class="number">2</span>,p);ta=a*a%p;<span class="keyword">if</span>(d%<span class="number">2</span>)ta=ta*x%p;<span class="keyword">return</span> ta%p;&#125;</span><br><span class="line">ll raw[maxn],u[maxn],siz;</span><br><span class="line"><span class="keyword">int</span> nxt[maxc][<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> w[maxc*<span class="number">2</span>];</span><br><span class="line">map&lt;<span class="keyword">int</span>,vector&lt;pair&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt;&gt; &gt;hsh;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> s,<span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> u = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">30</span>;i &gt;= <span class="number">0</span>;i--)&#123;</span><br><span class="line">		<span class="keyword">int</span> c = ((s&gt;&gt;i)&amp;<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span>(nxt[u][c] == <span class="number">-1</span>)nxt[u][c] = ++siz;</span><br><span class="line">		u = nxt[u][c];</span><br><span class="line">	&#125;</span><br><span class="line">	w[u] = idx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> k)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> u = <span class="number">0</span>,res = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">30</span>;i &gt;= <span class="number">0</span>;i--)&#123;</span><br><span class="line">		<span class="keyword">int</span> c = ((x&gt;&gt;i)&amp;<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span>(nxt[u][c^<span class="number">1</span>] != <span class="number">-1</span>)&#123;</span><br><span class="line">			res += (<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">			u = nxt[u][c^<span class="number">1</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nxt[u][c] != <span class="number">-1</span>)&#123;</span><br><span class="line">			u = nxt[u][c];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(res &lt; k)<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">return</span> w[u];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt;= siz;i++)&#123;</span><br><span class="line">		nxt[i][<span class="number">0</span>] = nxt[i][<span class="number">1</span>] = <span class="number">-1</span>;</span><br><span class="line">		w[i] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	siz = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">memset</span>(nxt,<span class="number">-1</span>,<span class="built_in"><span class="keyword">sizeof</span></span>(nxt));</span><br><span class="line">	ios::<span class="built_in">sync_with_stdio</span>(<span class="number">0</span>);</span><br><span class="line">	cin.<span class="built_in">tie</span>(<span class="number">0</span>);</span><br><span class="line">	cout.<span class="built_in">setf</span>(ios::fixed,ios::floatfield);</span><br><span class="line">	cout.<span class="built_in">precision</span>(<span class="number">12</span>);	 </span><br><span class="line">	<span class="keyword">int</span> n,k;</span><br><span class="line">	cin &gt;&gt; n &gt;&gt; k;</span><br><span class="line">	<span class="keyword">if</span>(!k)&#123;</span><br><span class="line">		cout &lt;&lt; n &lt;&lt; endl;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= n;i++)cout &lt;&lt; i &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> h = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">30</span>;i &gt;= <span class="number">0</span>;i--)<span class="keyword">if</span>((<span class="number">1</span>&lt;&lt;i)&amp;k)&#123;</span><br><span class="line">		h = i;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	set&lt;<span class="keyword">int</span>&gt;great,res;</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt;gidx;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= n;i++)&#123;</span><br><span class="line">		cin &gt;&gt; raw[i];</span><br><span class="line">		u[i] = raw[i];</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j = h;j &gt;= <span class="number">0</span>;j--)<span class="keyword">if</span>((<span class="number">1</span>&lt;&lt;j)&amp;u[i])u[i] -= (<span class="number">1</span>&lt;&lt;j);</span><br><span class="line">		cerr &lt;&lt; u[i] &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">		hsh[u[i]].<span class="built_in">push_back</span>(&#123;raw[i],i&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt;ans;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">auto</span> it:hsh)&#123;</span><br><span class="line">		vector&lt;pair&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt; &gt; &amp; r = it.second;</span><br><span class="line">		<span class="built_in">clear</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> it2:r)<span class="built_in">insert</span>(it2.first,it2.second);</span><br><span class="line">		<span class="keyword">bool</span> ok = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> it2:r)&#123;</span><br><span class="line">			<span class="keyword">int</span> x = <span class="built_in">query</span>(it2.first,k);</span><br><span class="line">			<span class="keyword">if</span>(x != <span class="number">-1</span>)&#123;</span><br><span class="line">				ans.<span class="built_in">push_back</span>(it2.second);</span><br><span class="line">				ans.<span class="built_in">push_back</span>(x);</span><br><span class="line">				ok = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!ok <span class="keyword">and</span> r.<span class="built_in">size</span>())ans.<span class="built_in">push_back</span>(r[<span class="number">0</span>].second);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(ans.<span class="built_in">size</span>() &lt; <span class="number">2</span>)&#123;</span><br><span class="line">		cout &lt;&lt; <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		cout &lt;&lt; ans.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> x:ans)cout &lt;&lt; x &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://linkinpony.github.io/2021/11/24/solution-CF1610D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LinkinPony">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I always love dashie">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/24/solution-CF1610D/" class="post-title-link" itemprop="url">[题解]CF1610D-Not Quite Lee</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-24 01:47:29" itemprop="dateCreated datePublished" datetime="2021-11-24T01:47:29+08:00">2021-11-24</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-01-13 14:44:30" itemprop="dateModified" datetime="2022-01-13T14:44:30+08:00">2022-01-13</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">-题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>经典我是傻逼环节.</p>
<h2 id="题意">题意</h2>
<p>给出长度为<span class="math inline">\(n\)</span>的数组<span class="math inline">\(A = \{a_i\}\)</span>, <span class="math inline">\(1 \leq n \leq 2 \cdot 10^5,1 \leq a_i \leq 10^9\)</span>.</p>
<p>对于<span class="math inline">\(A\)</span>的任意长度为<span class="math inline">\(m\)</span>的非空子序列<span class="math inline">\(B = \{b_1,b_2,..,b_m\}\)</span>, 定义<span class="math inline">\(f(b_i,k_i) = \sum_{j = 0}^{b_i} (j + k_i)\)</span>, 其中<span class="math inline">\(k_i\)</span>为任意整数. 一个子序列<span class="math inline">\(B\)</span>合法当且仅当 $ {k_i} |_{i = 1}^mf(b_i,k_i) = 0$.</p>
<p>求<span class="math inline">\(A\)</span>中全部合法子序列数量模<span class="math inline">\(10^9+7\)</span>.</p>
<h2 id="题解">题解</h2>
<p>首先我们考虑如何判断某个序列是否合法. 有<span class="math inline">\(f(b_i,k_i) = \frac{b_i\cdot(b_i + 1)}{2} + k_i\cdot b_i\)</span>, 那么<span class="math inline">\(\sum_{i = 1}^mf(b_i,k_i) = 0\)</span>可以转化为<span class="math inline">\(\sum_{i = 0}^m{\frac{b_i\cdot (b_i + 1)}{2}} = \sum_{i = 0}^m k_i \cdot b_i\)</span>. 这是一个一次不定方程. 设<span class="math inline">\(g = gcd(b_1,b_2,...,b_m)\)</span>, 当且仅当<span class="math inline">\(g | \sum_{i = 0}^m \frac{b_i \cdot (b_i+1)}{2}\)</span>时有整数解.</p>
<p>手画一下几组样例可以看出, 当序列中存在奇数时必定合法. 当序列中存在至少一个奇数时, 显然<span class="math inline">\(g\)</span>也是奇数. 那么对于每个<span class="math inline">\(\frac{b_i \cdot (b_i + 1)}{2}\)</span>, 如果<span class="math inline">\(b_i\)</span>是偶数有<span class="math inline">\(g | \frac{b_i}{2}\)</span>, 否则有<span class="math inline">\(g|(b_i + 1)\)</span> 且<span class="math inline">\(\frac{b_i}{2}\)</span>为整数. 因而序列中存在奇数时必有<span class="math inline">\(g | \sum_{i = 0}^m \frac{b_i \cdot (b_i+1)}{2}\)</span>.</p>
<p>设<span class="math inline">\(A\)</span>中奇数个数为<span class="math inline">\(odd\)</span>, 这一部分对答案的贡献为<span class="math inline">\((2^{odd} - 1) \cdot 2^{n-odd}\)</span></p>
<p>现在考虑序列中全为偶数的情况. 设<span class="math inline">\(h\)</span>是最大的使得<span class="math inline">\(2^h | g\)</span>的非负整数. 我们可以把<span class="math inline">\(g\)</span>拆分为<span class="math inline">\(g&#39; \cdot 2^h\)</span>. 显然<span class="math inline">\(g&#39;\)</span>为奇数. 根据上一段的讨论, 有<span class="math inline">\(g&#39; | \sum_{i = 0}^m \frac{b_i \cdot (b_i + 1)}{2}\)</span>. <strong>因而全为偶数的序列是否合法取决于</strong><span class="math inline">\(2^h\)</span><strong>能否整除</strong><span class="math inline">\(\sum_{i = 0}^m \frac{b_i \cdot (b_i + 1)}{2}\)</span>. 对于每个<span class="math inline">\(b_i\)</span>, 设<span class="math inline">\(l\)</span>是最大的使得<span class="math inline">\(2^l|b_i\)</span>的非负整数. <span class="math inline">\(l\)</span>可以分三种情况来讨论:</p>
<ul>
<li><p><span class="math inline">\(l &gt; h\)</span>.</p>
<p>此时有<span class="math inline">\(2^h | \frac{b_i}{2}\)</span>, 所以<span class="math inline">\(2^h | \frac{b_i \cdot(b_i + 1)}{2}\)</span>.</p></li>
<li><p><span class="math inline">\(l = h\)</span>.</p>
<p>此时<span class="math inline">\(2^h \nmid \frac{b_i}{2}\)</span>且<span class="math inline">\(b_i + 1\)</span>是奇数, 因此<span class="math inline">\(2^h \nmid \frac{b_i \cdot(b_i + 1)}{2}\)</span>. 由于<span class="math inline">\(\frac{b_i \cdot(b_i + 1)}{2 \cdot g&#39;} \mod 2^h = 2^{h-1}\)</span>, 如果这种情况下的<span class="math inline">\(b_i\)</span>个数有偶数个, 那它们的和仍然可以被<span class="math inline">\(2^h\)</span>整除.</p></li>
<li><p><span class="math inline">\(l &lt; h\)</span>. 由于<span class="math inline">\(g \geq 2^h\)</span>, 不可能存在这种情况.</p></li>
</ul>
<p>综上可知, 当序列中全为偶数时, 按能被<span class="math inline">\(2^l\)</span>整除的最大<span class="math inline">\(l\)</span>来对<span class="math inline">\(b_i\)</span>分类, 当且仅当<span class="math inline">\(l\)</span>最小那组的个数为偶数时序列合法. 在统计时可以枚举最小的<span class="math inline">\(l\)</span>.</p>
<p>总时间复杂度<span class="math inline">\(n \log (\max\{a_i\})\)</span></p>
<h2 id="代码">代码</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> int long long</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> endl <span class="meta-string">&#x27;\n&#x27;</span></span></span><br><span class="line"><span class="function">mt19937 <span class="title">Rand</span><span class="params">(chrono::steady_clock::now().time_since_epoch().count())</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">2e5</span>+<span class="number">10</span>;<span class="comment">//CHANGE IT!</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxm = maxn*<span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> p = <span class="number">1e9</span>+<span class="number">7</span>;<span class="comment">//CHANGE IT!</span></span><br><span class="line">ll fac[maxn],cnt[maxn];</span><br><span class="line"><span class="function">ll <span class="title">Pow</span><span class="params">(ll x,ll d,ll p = p)</span></span>&#123;ll ta=<span class="number">1</span>;<span class="keyword">if</span>(d==<span class="number">0</span>)<span class="keyword">return</span> <span class="number">1</span>%p;x %= p;ll a=<span class="built_in">Pow</span>(x,d/<span class="number">2</span>,p);ta=a*a%p;<span class="keyword">if</span>(d%<span class="number">2</span>)ta=ta*x%p;<span class="keyword">return</span> ta%p;&#125;</span><br><span class="line"><span class="function">ll <span class="title">C</span><span class="params">(ll n,ll m)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(m &gt; n)<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> (fac[n]*<span class="built_in">Pow</span>(fac[m],p<span class="number">-2</span>)%p*<span class="built_in">Pow</span>(fac[n-m],p<span class="number">-2</span>)%p)%p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	ios::<span class="built_in">sync_with_stdio</span>(<span class="number">0</span>);</span><br><span class="line">	cin.<span class="built_in">tie</span>(<span class="number">0</span>);</span><br><span class="line">	cout.<span class="built_in">setf</span>(ios::fixed,ios::floatfield);</span><br><span class="line">	cout.<span class="built_in">precision</span>(<span class="number">12</span>);	 </span><br><span class="line">	fac[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt; maxn;i++)fac[i] = fac[i<span class="number">-1</span>]*i%p;</span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	cin &gt;&gt; n;</span><br><span class="line">	<span class="keyword">int</span> odd = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= n;i++)&#123;</span><br><span class="line">		<span class="keyword">int</span> x;</span><br><span class="line">		cin &gt;&gt; x;</span><br><span class="line">		<span class="keyword">if</span>(x&amp;<span class="number">1</span>)odd++;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">int</span> qwq = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">while</span>(x%<span class="number">2</span> == <span class="number">0</span>)qwq++,x /= <span class="number">2</span>;</span><br><span class="line">			cnt[qwq+<span class="number">1</span>]++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	ll ans = (<span class="built_in">Pow</span>(<span class="number">2</span>,odd) - <span class="number">1</span> + p)%p*(<span class="built_in">Pow</span>(<span class="number">2</span>,n - odd)) % p;</span><br><span class="line">	ll res = n - odd;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">1</span>;k &lt;= <span class="number">32</span>;k++)<span class="keyword">if</span>(cnt[k])&#123;</span><br><span class="line">		ll tmp = <span class="number">0</span>;</span><br><span class="line">		res -= cnt[k];</span><br><span class="line">		ans = (ans + (<span class="built_in">Pow</span>(<span class="number">2</span>,cnt[k] - <span class="number">1</span>) - <span class="number">1</span> + p)%p * <span class="built_in">Pow</span>(<span class="number">2</span>,res) % p) % p;</span><br><span class="line">	&#125;</span><br><span class="line">	cout &lt;&lt; ans;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://linkinpony.github.io/2021/10/17/solution-ABC213E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LinkinPony">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I always love dashie">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/17/solution-ABC213E/" class="post-title-link" itemprop="url">solution-ABC213E</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-10-17 16:17:31" itemprop="dateCreated datePublished" datetime="2021-10-17T16:17:31+08:00">2021-10-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://linkinpony.github.io/2021/09/16/solution-HDU7059/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LinkinPony">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I always love dashie">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/16/solution-HDU7059/" class="post-title-link" itemprop="url">[题解]HDU7059-Counting Stars</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-09-16 19:53:14 / Modified: 20:03:48" itemprop="dateCreated datePublished" datetime="2021-09-16T19:53:14+08:00">2021-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="题意">题意</h2>
<p>本题是2021东北四省赛<a target="_blank" rel="noopener" href="https://codeforces.com/gym/103145/problem/D">D-Lowbit</a> 的强化版.</p>
<p>给出一个长度为<span class="math inline">\(n\)</span>的数列<span class="math inline">\(raw[]\)</span>, 维护下列三种操作:</p>
<p><code>1 l r</code>查询<span class="math inline">\(raw[l] + raw[l+1] + ... + raw[r]\)</span>对<span class="math inline">\(998244353\)</span>取模的值</p>
<p><code>2 l r</code>对区间<span class="math inline">\([l,r]\)</span>里的每个值分别减去其lowbit</p>
<p><code>3 l r</code>对区间<span class="math inline">\([l,r]\)</span>里的每个值分别加上其最高位的值</p>
<p><span class="math inline">\(1 \leq n,q \leq 10^5\)</span></p>
<h2 id="题解">题解</h2>
<p>容易发现对于操作2, 每个数<span class="math inline">\(a_i\)</span>在减去最多<span class="math inline">\(\log a_i\)</span>次后就会变成0. 因而我们暴力模拟这个过程, 同时用<span class="math inline">\(full[x] = 1\)</span>表示该节点下的所有值全部为0, 在之后的操作2中将这种节点忽略即可.</p>
<p>对于操作3, 只需把最高位拆出来单独维护即可. 注意操作2会影响到拆出来的最高位.</p>
<h2 id="代码">代码</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> endl <span class="meta-string">&#x27;\n&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> int long long</span></span><br><span class="line"><span class="function">mt19937 <span class="title">Rand</span><span class="params">(chrono::steady_clock::now().time_since_epoch().count())</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">2e5</span>+<span class="number">10</span>;<span class="comment">//CHANGE IT!</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxm = maxn*<span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> p = <span class="number">998244353</span>;<span class="comment">//CHANGE IT!</span></span><br><span class="line"><span class="keyword">int</span> p2[maxn];</span><br><span class="line"><span class="function">ll <span class="title">Pow</span><span class="params">(ll x,ll d)</span></span>&#123;ll ta=<span class="number">1</span>;<span class="keyword">if</span>(d==<span class="number">0</span>)<span class="keyword">return</span> <span class="number">1</span>%p;x %= p;ll a=<span class="built_in">Pow</span>(x,d/<span class="number">2</span>);ta=a*a%p;<span class="keyword">if</span>(d%<span class="number">2</span>)ta=ta*x%p;<span class="keyword">return</span> ta%p;&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Segtree</span>&#123;</span></span><br><span class="line">	<span class="keyword">int</span> siz = <span class="number">1</span>;</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt;hbit,addv,subv,sumv;</span><br><span class="line">	vector&lt;<span class="keyword">bool</span>&gt;full;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">		<span class="keyword">while</span>(siz &lt; n)siz *= <span class="number">2</span>;</span><br><span class="line">		hbit.<span class="built_in">assign</span>(siz*<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">		addv.<span class="built_in">assign</span>(siz*<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">		sumv.<span class="built_in">assign</span>(siz*<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">		full.<span class="built_in">assign</span>(siz*<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ls</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;<span class="keyword">return</span> (x&lt;&lt;<span class="number">1</span>)|<span class="number">1</span>;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">rs</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;<span class="keyword">return</span> (x&lt;&lt;<span class="number">1</span>)+<span class="number">2</span>;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">lowbit</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;<span class="keyword">return</span> x &amp; -x;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">highbit</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">30</span>;i &gt;= <span class="number">0</span>;i--)<span class="keyword">if</span>((<span class="number">1</span>&lt;&lt;i)&amp;x)<span class="keyword">return</span> (<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(full[<span class="built_in">ls</span>(x)] <span class="keyword">and</span> full[<span class="built_in">rs</span>(x)])full[x] = <span class="number">1</span>;</span><br><span class="line">		sumv[x] = (sumv[<span class="built_in">ls</span>(x)] + sumv[<span class="built_in">rs</span>(x)])%p;</span><br><span class="line">		hbit[x] = (hbit[<span class="built_in">ls</span>(x)] + hbit[<span class="built_in">rs</span>(x)])%p;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(addv[x])&#123;</span><br><span class="line">			<span class="keyword">int</span> &amp; v = addv[x];</span><br><span class="line">			addv[<span class="built_in">ls</span>(x)] += v,addv[<span class="built_in">rs</span>(x)] += v;</span><br><span class="line">			hbit[<span class="built_in">ls</span>(x)] = (hbit[<span class="built_in">ls</span>(x)] * p2[v])%p;</span><br><span class="line">			hbit[<span class="built_in">rs</span>(x)] = (hbit[<span class="built_in">rs</span>(x)] * p2[v])%p;</span><br><span class="line">			v = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp; in,<span class="keyword">int</span> x,<span class="keyword">int</span> lx,<span class="keyword">int</span> rx)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(rx - lx == <span class="number">1</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>(lx &lt; (<span class="keyword">int</span>)in.<span class="built_in">size</span>())&#123;</span><br><span class="line">				<span class="keyword">int</span> h = <span class="built_in">highbit</span>(in[lx]);</span><br><span class="line">				hbit[x] = h;</span><br><span class="line">				in[lx] -= h;</span><br><span class="line">				sumv[x] = in[lx];</span><br><span class="line">				<span class="keyword">if</span>(!sumv[x] <span class="keyword">and</span> !hbit[x])full[x] = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> m = (lx+rx)/<span class="number">2</span>;</span><br><span class="line">		<span class="built_in">build</span>(in,<span class="built_in">ls</span>(x),lx,m);</span><br><span class="line">		<span class="built_in">build</span>(in,<span class="built_in">rs</span>(x),m,rx);</span><br><span class="line">		<span class="built_in">pushup</span>(x);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp; in)</span></span>&#123;</span><br><span class="line">		<span class="built_in">build</span>(in,<span class="number">0</span>,<span class="number">0</span>,siz);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> x,<span class="keyword">int</span> lx,<span class="keyword">int</span> rx)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(l &gt;= rx <span class="keyword">or</span> lx &gt;= r)<span class="keyword">return</span>;</span><br><span class="line">		<span class="keyword">if</span>(rx - lx &gt; <span class="number">1</span>)<span class="built_in">pushdown</span>(x);</span><br><span class="line">		<span class="keyword">if</span>(l &lt;= lx <span class="keyword">and</span> rx &lt;= r)&#123;</span><br><span class="line">			hbit[x] = (hbit[x]*<span class="number">2</span>)%p;</span><br><span class="line">			addv[x]++;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> m = (lx+rx)/<span class="number">2</span>;</span><br><span class="line">		<span class="built_in">add</span>(l,r,<span class="built_in">ls</span>(x),lx,m);</span><br><span class="line">		<span class="built_in">add</span>(l,r,<span class="built_in">rs</span>(x),m,rx);</span><br><span class="line">		<span class="built_in">pushup</span>(x);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> l,<span class="keyword">int</span> r)</span></span>&#123;</span><br><span class="line">		r++;</span><br><span class="line">		<span class="built_in">add</span>(l,r,<span class="number">0</span>,<span class="number">0</span>,siz);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sub</span><span class="params">(<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> x,<span class="keyword">int</span> lx,<span class="keyword">int</span> rx)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(l &gt;= rx <span class="keyword">or</span> lx &gt;= r)<span class="keyword">return</span>;</span><br><span class="line">		<span class="keyword">if</span>(rx - lx &gt; <span class="number">1</span>)<span class="built_in">pushdown</span>(x);</span><br><span class="line">		<span class="keyword">if</span>(l &lt;= lx <span class="keyword">and</span> rx &lt;= r)&#123;</span><br><span class="line">			<span class="keyword">if</span>(full[x])&#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(rx - lx == <span class="number">1</span>)&#123;</span><br><span class="line">				<span class="keyword">if</span>(!sumv[x])&#123;</span><br><span class="line">					full[x] = <span class="number">1</span>;</span><br><span class="line">					hbit[x] = <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				sumv[x] -= <span class="built_in">lowbit</span>(sumv[x]);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> m = (lx+rx)/<span class="number">2</span>;</span><br><span class="line">		<span class="built_in">sub</span>(l,r,<span class="built_in">ls</span>(x),lx,m);</span><br><span class="line">		<span class="built_in">sub</span>(l,r,<span class="built_in">rs</span>(x),m,rx);</span><br><span class="line">		<span class="built_in">pushup</span>(x);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sub</span><span class="params">(<span class="keyword">int</span> l,<span class="keyword">int</span> r)</span></span>&#123;</span><br><span class="line">		r++;</span><br><span class="line">		<span class="built_in">sub</span>(l,r,<span class="number">0</span>,<span class="number">0</span>,siz);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">ll <span class="title">sum</span><span class="params">(<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> x,<span class="keyword">int</span> lx,<span class="keyword">int</span> rx)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(l &gt;= rx <span class="keyword">or</span> lx &gt;= r)<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(rx - lx &gt; <span class="number">1</span>)<span class="built_in">pushdown</span>(x);</span><br><span class="line">		<span class="keyword">if</span>(l &lt;= lx <span class="keyword">and</span> rx &lt;= r)&#123;</span><br><span class="line">			<span class="keyword">return</span> (sumv[x] + hbit[x])%p;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> m = (lx+rx)/<span class="number">2</span>;</span><br><span class="line">		ll s1 = <span class="built_in">sum</span>(l,r,<span class="built_in">ls</span>(x),lx,m);</span><br><span class="line">		ll s2 = <span class="built_in">sum</span>(l,r,<span class="built_in">rs</span>(x),m,rx);</span><br><span class="line">		<span class="keyword">return</span> (s1+s2)%p;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">ll <span class="title">sum</span><span class="params">(<span class="keyword">int</span> l,<span class="keyword">int</span> r)</span></span>&#123;</span><br><span class="line">		r++;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">sum</span>(l,r,<span class="number">0</span>,<span class="number">0</span>,siz);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	ios::<span class="built_in">sync_with_stdio</span>(<span class="number">0</span>);</span><br><span class="line">	cin.<span class="built_in">tie</span>(<span class="number">0</span>);</span><br><span class="line">	cout.<span class="built_in">setf</span>(ios::fixed,ios::floatfield);</span><br><span class="line">	cout.<span class="built_in">precision</span>(<span class="number">12</span>);</span><br><span class="line">	p2[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt; maxn;i++)p2[i] = p2[i<span class="number">-1</span>]*<span class="number">2</span>%p;	 </span><br><span class="line">	<span class="keyword">int</span> __;</span><br><span class="line">	cin &gt;&gt; __;</span><br><span class="line">	<span class="keyword">while</span>(__--)&#123;</span><br><span class="line">		<span class="keyword">int</span> n;</span><br><span class="line">		cin &gt;&gt; n;</span><br><span class="line">		vector&lt;<span class="keyword">int</span>&gt;<span class="built_in">in</span>(n+<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= n;i++)cin &gt;&gt; in[i];</span><br><span class="line">		Segtree seg;</span><br><span class="line">		seg.<span class="built_in">init</span>(n+<span class="number">10</span>);</span><br><span class="line">		seg.<span class="built_in">build</span>(in);</span><br><span class="line">		<span class="keyword">int</span> q;</span><br><span class="line">		cin &gt;&gt; q;</span><br><span class="line">		<span class="keyword">while</span>(q--)&#123;</span><br><span class="line">			<span class="keyword">int</span> opt,l,r;</span><br><span class="line">			cin &gt;&gt; opt &gt;&gt; l &gt;&gt; r;</span><br><span class="line">			<span class="keyword">if</span>(opt == <span class="number">1</span>)cout &lt;&lt; seg.<span class="built_in">sum</span>(l,r) &lt;&lt; endl;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(opt == <span class="number">2</span>)seg.<span class="built_in">sub</span>(l,r);</span><br><span class="line">			<span class="keyword">else</span> seg.<span class="built_in">add</span>(l,r);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LinkinPony</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","cdn":"//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
